{% extends 'base_user.html' %}

{% block script %}
    <script>
        $(function () {
            init_calc();
            // 为所有的checkbox绑定点击事件(除了全选)
            $(':checkbox:not(#checkall)').click(function () {
                init_calc();
                // 设置全选的状态
                // 如果所有复选框都选中(除了全选),则返回true
                // 所有的复选框个数(除了checkall)
                var checkbox_len = $(':checkbox:not(#checkall)').length;
                // 选中的复选框个数(除了checkall)
                var checked_len = $(':checked:not(#checkall)').length;
                var checked = checkbox_len == checked_len;
                $('#checkall').prop('checked', checked);
            });
            // 为全选绑定点击事件
            $('#checkall').click(function () {
                // 获取当前选中状态
                var checked = $(this).prop('checked');
                // 如果当前选中，则其他都选中
                // 如果当前不选中，则其他都不选中
                $(':checkbox:not(#checkall)').prop('checked', checked);
                init_calc();
            });

            // 为数量文本框绑定失去焦点事件
            $('.num_show').blur(function () {
                // 获取当前文本框中的数量值
                var count = parseInt($(this).val())
                // 有效性判断
                if (isNaN(count)) {
                    count = 1;
                }
                else if (count < 1) {
                    count = 1;
                }
                else if (count > 5) {
                    count = 5;
                }
                $(this).val(count);

                // 修改数据库中的记录
                $.post('/cart/edit', {
                    'sku_id': $(this).parents('ul').attr('id'),
                    'count': count,
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                }, function (data) {
                    if (data.result == 'ok') {
                        // 重新计算
                        init_calc();
                    }
                });

            });

            // 为+绑定点击事件
            $('.add').click(function () {
                // 区文本框的值+1
                var count = parseInt($(this).next().val());
                count++;
                if (count <= 5){
                $(this).next().val(count).blur()
                }
            });

            // 为-绑定点击事件
            $('.minus').click(function () {
                  // 区文本框的值-1
                var count = parseInt($(this).prev().val());
                count--;
                if (count >= 1){
                $(this).prev().val(count).blur()
                }
            });

            // 绑定删除事件
            $('.cart_del').click(function () {
                if(confirm('确定要删除此商品吗？')){
                    var ul = $(this).parents('ul');
                    $.post('/cart/delete', {
                        'sku_id': ul.attr('id'),
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                    }, function (data) {
                        // 在回调函数中,this表示本次的异步请求对象
                        if (data.result == 'ok'){
                            // 将ul 从页面中删除
                            ul.remove();
                            // 重新计算
                            init_calc();
                        }
                    });
                }
            });
        });
        // 初始计算,遍历所有商品,计算小计,并计算总价
        function init_calc() {
            var total_money = 0, total_count1 = 0, total_count2 = 0;
            $('.cart_list_td').each(function (i, n) {
                // i表示索引
                // n表示对象,此处即cart_list_td的ul
                // 获取单价
                var price = parseFloat($(n).children('.col05').children('span').text());
                // 获取数量
                var count = parseInt($(n).find('.num_show').val());
                // 小计
                var total = price * count;
                // 显示小计
                $(n).children('.col07').text(total.toFixed(2) + '元');

                // 如果当前ul中的checkbox被选中,则执行计算
                if ($(n).children('.col01').children('input').prop('checked')) {
                    // 总计
                    total_money += total;
                    // 选中的总数量
                    total_count2 += count;
                }

                // 总数量
                total_count1 += count;
            });
            // 显示总计
            $('.settlements em').text(total_money.toFixed(2));
            // 显示总数量
            $('.total_count>em').text(total_count1);
            // 显示选中总数量
            $('.settlements b').text(total_count2);
        }
    </script>
{% endblock %}

{% block body1 %}
    <div class="total_count">全部商品<em></em>件</div>
    <ul class="cart_list_th clearfix">
        <li class="col01">商品名称</li>
        <li class="col02">商品单位</li>
        <li class="col03">商品价格</li>
        <li class="col04">数量</li>
        <li class="col05">小计</li>
        <li class="col06">操作</li>
    </ul>
    <form action="/order/" method="get">
    {% for sku in cart_list %}
        <ul class="cart_list_td clearfix" id="{{ sku.id }}">
            <li class="col01"><input type="checkbox" name="sku_id" value="{{ sku.id }}" checked></li>
            <li class="col02"><img src="{{ sku.default_image.url }}"></li>
            <li class="col03">{{ sku.name }}<br><em>{{ sku.stock }}</em></li>
            <li class="col04">{{ sku.unit }}</li>
            <li class="col05"><span>{{ sku.price }}</span>>元</li>
            <li class="col06">
                <div class="num_add">
                    <a href="javascript:;" class="add fl">+</a>
                    <input type="text" class="num_show fl" value="{{ sku.cart_count }}">
                    <a href="javascript:;" class="minus fl">-</a>
                </div>
            </li>
            <li class="col07"></li>
            <li class="col08"><a href="javascript:;" class="cart_del">删除</a></li>
        </ul>
    {% endfor %}



    <ul class="settlements">
        <li class="col01"><input type="checkbox" id="checkall" checked></li>
        <li class="col02">全选</li>
        <li class="col03">合计(不含运费)：<span>¥</span><em></em><br>共计<b></b>件商品</li>
        <li class="col04">
        <input type="submit" value="去结算">
        </li>
    </ul>
</form>
{% endblock %}